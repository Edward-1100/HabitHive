<!doctype html>

<html lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Leaderboard</title>
    <link rel="icon" href="/images/honeycomb.png">
    <link rel="stylesheet" href="/css/style.css" />
  </head>

  <body>
    <%- include('partials/nav') %>

    <main class="container leaderboard-wrap">

      <div class="leaderboard-header">

        <div>
          <h1 style="margin:0;">Leaderboard</h1>
          <div class="leaderboard-sub">Top users by <strong><%= (mode === 'streak') ? 'streak' : 'points' %></strong> - top 10 shown</div>
        </div>

        <div style="margin-left:auto;">
          <div class="mode-toggle" role="tablist" aria-label="Leaderboard mode">
            <a href="/leaderboard?mode=points" class="<%= (mode === 'points') ? 'mode-active' : '' %>">Points</a>
            <a href="/leaderboard?mode=streak" class="<%= (mode === 'streak') ? 'mode-active' : '' %>">Streaks</a>
          </div>
        </div>

      </div>

      <table class="leaderboard-table" role="table" aria-label="Leaderboard">
        <thead>
          <tr>
            <th class="leaderboard-rank">Rank</th>
            <th>User</th>
            <th class="points-cell"><%= (mode === 'streak') ? 'Streak' : 'Points' %></th>
          </tr>
        </thead>

        <tbody>
          <% 
            const top = Array.isArray(topUsers) ? topUsers : [];
            const current = currentUser || null;
            const highlightId = current ? String(current._id || current.id) : null;
            const inTop = highlightId ? top.some(u => String(u._id || u.id) === highlightId) : false;
          %>

          <% if (top.length === 0) { %>
            <tr><td colspan="3">No users yet.</td></tr>
          <% } else { %>

            <% top.forEach(function(u, idx) { 
                 const rank = idx + 1;
                 const uId = String(u._id || u.id);
                 const isCurrent = (highlightId && uId === highlightId);
            %>
            
              <tr class="<%= isCurrent ? 'leaderboard-highlight' : '' %>">

                <td class="leaderboard-rank">
                  <% if (rank === 1) { %>
                    <span class="rank-badge rank-1">1</span>
                  <% } else if (rank === 2) { %>
                    <span class="rank-badge rank-2">2</span>
                  <% } else if (rank === 3) { %>
                    <span class="rank-badge rank-3">3</span>
                  <% } else { %>
                    <span><%= rank %></span>
                  <% } %>
                </td>

                <td>
                  <div class="leaderboard-user">
                    <img class="avatar-sm" src="<%= (u.profileImage && u.profileImage.length) ? u.profileImage : '/images/honeycomb.png' %>" alt="<%= u.username %>'s avatar" onerror="this.src='/images/honeycomb.png'">
                    
                    <div>
                      <a href="/profile/<%= u._id %>"><strong><%= u.username %></strong></a>
                      <div class="muted" style="font-size:0.85rem;"><%= u.email ? u.email : '' %></div>
                    </div>

                  </div>

                </td>

                <td class="points-cell">
                  <% if (mode === 'streak') { %>
                    <%= typeof u.streak === 'number' ? u.streak : 0 %>
                  <% } else { %>
                    <%= (typeof u.points === 'number') ? u.points : (u.points || 0) %>
                  <% } %>
                </td>
              </tr>

            <% }) %>

          <% } %>

          <% if (current && !inTop) { %>
            <tr class="spacer-row"><td colspan="3"></td></tr>
            
            <tr class="leaderboard-highlight">
              <td class="leaderboard-rank"><span class="rank-badge"><%= userRank || '-' %></span></td>

              <td>

                <div class="leaderboard-user">
                  <img class="avatar-sm" src="<%= (current.profileImage && current.profileImage.length) ? current.profileImage : '/images/honeycomb.png' %>" alt="<%= current.username %>'s avatar" onerror="this.src='/images/honeycomb.png'">
                  
                  <div>
                    <a href="/profile/<%= current._id %>"><strong><%= current.username %></strong></a>
                    <div class="muted" style="font-size:0.85rem;">Your rank</div>
                  </div>

                </div>

              </td>

              <td class="points-cell">
                <% if (mode === 'streak') { %>
                  <%= typeof current.streak === 'number' ? current.streak : 0 %>
                <% } else { %>
                  <%= (typeof current.points === 'number') ? current.points : (current.points || 0) %>
                <% } %>
              </td>

            </tr>

          <% } %>

        </tbody>

      </table>

    </main>

  </body>

</html>
